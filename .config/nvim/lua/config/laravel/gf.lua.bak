local snacks = require "snacks"
local utils = require "config.laravel.utils"

local M = {}

-- Helper function to execute default gf behavior
local function default_gf()
    -- Save the current isfname setting
    local old_isfname = vim.opt.isfname:get()

    -- Temporarily modify isfname to include common path characters
    vim.opt.isfname:append { ".", "/", "-", "_" }

    -- Execute the default gf command in a protected call
    local success, _ = pcall(function()
        vim.cmd "normal! gf"
    end)

    -- Restore the original isfname setting
    vim.opt.isfname = old_isfname

    if not success then
        vim.notify("File not found under cursor", vim.log.levels.WARN)
    end
end

-- Helper function to recursively find all PHP files in routes directory
local function find_route_files(directory)
    local files = {}
    if vim.fn.isdirectory(directory) == 0 then
        return files
    end

    local entries = vim.fn.readdir(directory)
    for _, entry in ipairs(entries) do
        local full_path = directory .. "/" .. entry
        local stat = vim.loop.fs_stat(full_path)

        if stat then
            if stat.type == "directory" then
                -- Recursively search subdirectories
                vim.list_extend(files, find_route_files(full_path))
            elseif stat.type == "file" and entry:match "%.php$" then
                -- Add PHP files
                table.insert(files, full_path)
            end
        end
    end

    return files
end

M.goto_file_under_cursor = function()
    -- If not in a Laravel project, use default gf
    if not utils.is_laravel_project() then
        default_gf()
        return
    end

    local laravel_root = utils.get_laravel_root()
    local line = vim.api.nvim_get_current_line()
    local col = vim.api.nvim_win_get_cursor(0)[2] + 1

    -- Helper function to extract string content from quotes
    local function extract_quoted_string(text, pos)
        -- Find the quote that contains or is nearest to the cursor position
        local quote_patterns = { "'([^']*)'", '"([^"]*)"' }

        for _, pattern in ipairs(quote_patterns) do
            local start_pos = 1
            while true do
                local quote_start, quote_end, content = text:find(pattern, start_pos)
                if not quote_start then
                    break
                end

                -- Check if cursor is within this quoted string
                if pos >= quote_start and pos <= quote_end then
                    return content, quote_start, quote_end
                end
                start_pos = quote_end + 1
            end
        end
        return nil
    end

    local quoted_content = extract_quoted_string(line, col)

    -- If no quoted string found, try default gf
    if not quoted_content then
        default_gf()
        return
    end

    local possible_files = {}

    -- Volt route references: Volt::route('categories/', 'categories.index') → resources/views/livewire/categories/index.blade.php
    if line:match "Volt::route%s*%(" then
        -- Extract the second parameter which is the component path
        local volt_patterns = {
            "Volt::route%s*%([^,]*,%s*['\"]([^'\"]*)['\"]",
            "Volt::route%s*%([^,]*,%s*['\"]([^'\"]*)['\"]",
        }

        for _, pattern in ipairs(volt_patterns) do
            local volt_component = line:match(pattern)
            if volt_component then
                local volt_path = volt_component:gsub("%.", "/") .. ".blade.php"
                local volt_file = laravel_root .. "/resources/views/livewire/" .. volt_path

                if vim.fn.filereadable(volt_file) == 1 then
                    table.insert(possible_files, {
                        file = volt_file,
                        description = "Volt component: " .. volt_component,
                        type = "volt",
                    })
                end
                break
            end
        end
    end

    -- Enhanced Route references: route('dashboard') → any PHP file in routes/
    if line:match "route%s*%(" then
        local routes_directory = laravel_root .. "/routes"
        local route_files = find_route_files(routes_directory)
        local current_file = vim.api.nvim_buf_get_name(0)
        local current_line_num = vim.api.nvim_win_get_cursor(0)[1]

        for _, route_file in ipairs(route_files) do
            -- Search for the route name in the file
            local content = vim.fn.readfile(route_file)
            for line_num, file_line in ipairs(content) do
                -- Skip if this is the current file and current line (avoid suggesting the same line we're on)
                if route_file == current_file and line_num == current_line_num then
                    goto next_file_line
                end
                -- Enhanced patterns to match various route definitions
                local patterns = {
                    -- Standard named routes: ->name('route.name')
                    "->name%s*%(%s*['\"]"
                        .. vim.pesc(quoted_content)
                        .. "['\"]",
                    -- Route with name as second parameter: Route::get('/path', 'route.name')
                    "Route::[^%(]*%([^,]*,%s*['\"]"
                        .. vim.pesc(quoted_content)
                        .. "['\"]",
                    -- Route::resource patterns
                    "Route::resource%s*%(%s*['\"][^'\"]*['\"]%s*,%s*[^,)]*%)%s*;.*" .. vim.pesc(quoted_content),
                    -- Check if it's a resource route by matching the pattern
                    "Route::resource%s*%(%s*['\"]([^'\"]*)['\"]",
                }

                for _, pattern in ipairs(patterns) do
                    if file_line:match(pattern) then
                        table.insert(possible_files, {
                            file = route_file,
                            line = line_num,
                            description = "Route definition: " .. quoted_content .. " (in " .. vim.fn.fnamemodify(
                                route_file,
                                ":t"
                            ) .. ")",
                            type = "route",
                        })
                        goto next_file_line
                    end
                end

                -- Special handling for Route::resource
                local resource_name = file_line:match "Route::resource%s*%(%s*['\"]([^'\"]*)['\"]"
                if resource_name then
                    -- Check if the quoted_content matches a resource route pattern
                    local resource_routes = {
                        resource_name .. ".index",
                        resource_name .. ".create",
                        resource_name .. ".store",
                        resource_name .. ".show",
                        resource_name .. ".edit",
                        resource_name .. ".update",
                        resource_name .. ".destroy",
                    }

                    for _, route_name in ipairs(resource_routes) do
                        if route_name == quoted_content then
                            table.insert(possible_files, {
                                file = route_file,
                                line = line_num,
                                description = "Resource route: "
                                    .. quoted_content
                                    .. " (from "
                                    .. resource_name
                                    .. " in "
                                    .. vim.fn.fnamemodify(route_file, ":t")
                                    .. ")",
                                type = "route",
                            })
                            goto next_file_line
                        end
                    end
                end

                ::next_file_line::
            end
        end
    end

    -- View references: view('users.index') → resources/views/users/index.blade.php
    if line:match "view%s*%(" or line:match "@extends%s*%(" or line:match "@include%s*%(" then
        local view_path = quoted_content:gsub("%.", "/") .. ".blade.php"
        local view_file = laravel_root .. "/resources/views/" .. view_path

        if vim.fn.filereadable(view_file) == 1 then
            table.insert(possible_files, {
                file = view_file,
                description = "Blade view: " .. quoted_content,
                type = "view",
            })
        end
    end

    -- Inertia references: Inertia::render('Dashboard') → resources/js/Pages/Dashboard.tsx
    if line:match "Inertia::render%s*%(" or line:match "inertia%s*%(" then
        local inertia_extensions = { ".tsx", ".jsx", ".vue", ".js", ".ts" }
        local inertia_path = quoted_content:gsub("%.", "/")

        for _, ext in ipairs(inertia_extensions) do
            local inertia_file = laravel_root .. "/resources/js/pages/" .. inertia_path .. ext
            if vim.fn.filereadable(inertia_file) == 1 then
                table.insert(possible_files, {
                    file = inertia_file,
                    description = "Inertia page: " .. quoted_content,
                    type = "inertia",
                })
                break
            end
        end
    end

    -- Config references: config('app.name') → config/app.php
    if line:match "config%s*%(" then
        local config_parts = vim.split(quoted_content, ".", { plain = true })
        if #config_parts > 0 then
            local config_file = laravel_root .. "/config/" .. config_parts[1] .. ".php"
            if vim.fn.filereadable(config_file) == 1 then
                local line_num = nil
                if #config_parts > 1 then
                    -- Try to find the specific config key
                    local content = vim.fn.readfile(config_file)
                    local key_pattern = "['\"]" .. vim.pesc(config_parts[2]) .. "['\"]%s*=>"
                    for i, file_line in ipairs(content) do
                        if file_line:match(key_pattern) then
                            line_num = i
                            break
                        end
                    end
                end

                table.insert(possible_files, {
                    file = config_file,
                    line = line_num,
                    description = "Config: " .. quoted_content,
                    type = "config",
                })
            end
        end
    end

    -- Translation references: __('auth.failed') → lang/en/auth.php
    if line:match "__%s*%(" or line:match "trans%s*%(" or line:match "@lang%s*%(" then
        local trans_parts = vim.split(quoted_content, ".", { plain = true })
        if #trans_parts >= 2 then
            local lang_file = trans_parts[1] .. ".php"
            local lang_dirs = {
                laravel_root .. "/lang/en/",
                laravel_root .. "/resources/lang/en/",
                laravel_root .. "/lang/",
                laravel_root .. "/resources/lang/",
            }

            for _, lang_dir in ipairs(lang_dirs) do
                local full_path = lang_dir .. lang_file
                if vim.fn.filereadable(full_path) == 1 then
                    local line_num = nil
                    if #trans_parts > 1 then
                        -- Try to find the specific translation key
                        local content = vim.fn.readfile(full_path)
                        local key_pattern = "['\"]" .. vim.pesc(trans_parts[2]) .. "['\"]%s*=>"
                        for i, file_line in ipairs(content) do
                            if file_line:match(key_pattern) then
                                line_num = i
                                break
                            end
                        end
                    end

                    table.insert(possible_files, {
                        file = full_path,
                        line = line_num,
                        description = "Translation: " .. quoted_content,
                        type = "translation",
                    })
                    break
                end
            end
        end
    end

    -- Environment variables: env('APP_NAME') → .env file
    if line:match "env%s*%(" then
        local env_files = {
            laravel_root .. "/.env",
            laravel_root .. "/.env.local",
            laravel_root .. "/.env.example",
        }

        for _, env_file in ipairs(env_files) do
            if vim.fn.filereadable(env_file) == 1 then
                local line_num = nil
                -- Try to find the specific environment variable
                local content = vim.fn.readfile(env_file)
                local env_pattern = "^" .. vim.pesc(quoted_content) .. "%s*="
                for i, file_line in ipairs(content) do
                    if file_line:match(env_pattern) then
                        line_num = i
                        break
                    end
                end

                table.insert(possible_files, {
                    file = env_file,
                    line = line_num,
                    description = "Environment variable: " .. quoted_content,
                    type = "env",
                })
                break
            end
        end
    end

    -- Component references: <x-button> → resources/views/components/button.blade.php
    if line:match "<x%-[%w%-%.]+" then
        local component_match = line:match "<x%-([%w%-%.]+)"
        if component_match then
            local component_path = component_match:gsub("%-", "/")
            local component_file = laravel_root .. "/resources/views/components/" .. component_path .. ".blade.php"

            if vim.fn.filereadable(component_file) == 1 then
                table.insert(possible_files, {
                    file = component_file,
                    description = "Blade component: x-" .. component_match,
                    type = "component",
                })
            end
        end
    end

    -- Asset references: asset('js/flowbite.js') → public/js/flowbite.js
    if line:match "asset%s*%(" then
        local asset_file = laravel_root .. "/public/" .. quoted_content

        if vim.fn.filereadable(asset_file) == 1 then
            table.insert(possible_files, {
                file = asset_file,
                description = "Asset: " .. quoted_content,
                type = "asset",
            })
        end
    end

    -- TODO:
    -- Livewire tag references: <livewire:partials.promotions /> → resources/views/livewire/partials/promotions.blade.php

    -- Model references: App\Models\User → app/Models/User.php
    if line:match "App\\Models\\" or line:match "App\\\\Models\\\\" then
        local model_match = line:match "App\\?\\?Models\\?\\?([%w\\]+)" or line:match "App\\Models\\([%w\\]+)"
        if model_match then
            local model_path = model_match:gsub("\\", "/")
            local model_file = laravel_root .. "/app/Models/" .. model_path .. ".php"

            if vim.fn.filereadable(model_file) == 1 then
                table.insert(possible_files, {
                    file = model_file,
                    description = "Model: " .. model_match,
                    type = "model",
                })
            end
        end
    end

    -- If no Laravel-specific files found, fallback to default gf
    if #possible_files == 0 then
        default_gf()
        return
    end

    -- If only one file found, open it directly
    if #possible_files == 1 then
        local file_info = possible_files[1]
        vim.cmd("edit " .. file_info.file)
        if file_info.line then
            vim.api.nvim_win_set_cursor(0, { file_info.line, 0 })
        end
        -- vim.notify("Opened: " .. file_info.description, vim.log.levels.INFO)
        return
    end

    -- Multiple files found, show picker
    for _, file_info in ipairs(possible_files) do
        file_info.text = file_info.description
        file_info.search_key = file_info.description
    end

    snacks.picker.pick {
        name = "Laravel Files for: " .. quoted_content,
        layout = "vscode",
        items = possible_files,
        format = function(item)
            return {
                { item.description, "SnacksPickerFile" },
                { " [" .. item.type .. "]", "Comment" },
            }
        end,
        confirm = function(picker, item)
            if item then
                picker:close()
                vim.cmd("edit " .. item.file)
                if item.line then
                    vim.api.nvim_win_set_cursor(0, { item.line, 0 })
                end
            end
        end,
    }
end

return M
