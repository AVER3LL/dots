#!/usr/bin/env bash
# Wallpaper Manager Script
# This script sets a wallpaper and creates various cached versions for different uses

# Initialize SET_WALLPAPER flag (default: true)
SET_WALLPAPER=true

# Check if user wants to skip setting wallpaper
if [ "$1" = "--no-set" ]; then
    SET_WALLPAPER=false
    shift # Remove --no-set from arguments
fi

# Check if required tools are installed
check_dependencies() {
    local critical_deps=(swww matugen wallust)
    local missing_deps=()
    for cmd in "${critical_deps[@]}"; do
        command -v "$cmd" >/dev/null 2>&1 || missing_deps+=("$cmd")
    done

    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo "Error: Missing critical dependencies: ${missing_deps[*]}" >&2
        notify-send "Wallpaper error" "Error: Missing dependencies: ${missing_deps[*]}"
        echo "Please install the required tools and try again."
        exit 1
    fi
}

# Check if the user provided an argument
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 [--no-set] <path-to-image>"
    exit 1
fi

# Run dependency check
check_dependencies

IMAGE="$1"

# Check if the file exists and is an image
if [ ! -f "$IMAGE" ]; then
    echo "Error: '$IMAGE' does not exist."
    exit 1
fi

# A more robust image check using file command
if ! file "$IMAGE" | grep -qE 'image|bitmap|PNG|JPEG|JPG|GIF|BMP|SVG'; then
    echo "Error: '$IMAGE' is not a valid image file."
    exit 1
fi

# Send notification to the user
echo "Changing wallpaper..."

# Set the wallpaper using swww - this happens first and doesn't wait
if $SET_WALLPAPER; then
    swww img "$IMAGE" --transition-type="left" --transition-duration=2 --transition-step=90 --transition-angle=0 --transition-fps=60 || {
        echo "Error: Failed to set wallpaper with swww."
        exit 1
    }
fi

brightness=$(magick "$IMAGE" -colorspace Gray -resize 1x1\! -format "%[fx:round(255*r)]" info:)
if [ -z "$brightness" ] || ! [[ "$brightness" =~ ^[0-9]+$ ]]; then
    echo "Warning: Could not calculate brightness, defaulting to dark theme"
    brightness=100 # Default to below threshold (dark)
fi
threshold=130

if ((brightness > threshold)); then
    # Light background - use primary color for border
    sed -i 's/^\$hyprborder = .*/\$hyprborder = rgba({{colors.primary.default.hex_stripped}}ff)/' ~/.config/matugen/templates/hyprland-colors.conf
else
    # Dark background - use fixed dark color for border
    sed -i 's/^\$hyprborder = .*/\$hyprborder = rgba(3e4142ff)/' ~/.config/matugen/templates/hyprland-colors.conf
fi

# Define cache directory and files
WALLPAPER_CACHE_DIR="$HOME/.cache/averell/"
wallSet="${WALLPAPER_CACHE_DIR}/original.set"
wallCur="${WALLPAPER_CACHE_DIR}/wall.set"
wallSqr="${WALLPAPER_CACHE_DIR}/wall.sqre" # Square crop of the wallpaper
wallTmb="${WALLPAPER_CACHE_DIR}/wall.thmb" # Thumbnail version
wallBlr="${WALLPAPER_CACHE_DIR}/wall.blur" # Blurred version for backgrounds
wallQad="${WALLPAPER_CACHE_DIR}/wall.quad"

# Ensure cache directory exists
mkdir -p "$WALLPAPER_CACHE_DIR"

# Save original image path
ln -sf "$IMAGE" "$wallCur" &       # Background link creation
printf '%s\n' "$IMAGE" >"$wallSet" # More efficient than echo

# Create a function for the background processing
generate_caches() {
    local image="$1"
    local cache_dir="$2"

    local extension="${image##*.}"
    local extension_lc="$(echo "$extension" | tr '[:upper:]' '[:lower:]')"
    local cache_src="$image"
    local temp_frame=""

    mkdir -p "$cache_dir"

    # If it's a gif, extract first frame
    if [ "$extension_lc" = "gif" ]; then
        temp_frame="${cache_dir}/wall.firstframe.png"
        magick "$image[0]" "$temp_frame" || {
            echo "Warning: Failed to extract first frame from GIF."
        }
        cache_src="$temp_frame"
    fi

    echo "Processing all outputs in one pass..."

    magick "$cache_src" \
        -strip \
        \( +clone -thumbnail 500x500^ -gravity center -extent 500x500 -write "$wallSqr" +delete \) \
        \( +clone -thumbnail 320x180^ -gravity center -extent 320x180 -write "$wallTmb" +delete \) \
        \( +clone -resize 1920x1080^ -gravity center -extent 1920x1080 -blur 0x8 -write "$wallBlr" +delete \) \
        null: >/dev/null || echo "Warning: Failed to generate images."

    # Generate quad from square version
    if [ -f "$wallSqr" ]; then
        echo "Generating quad version..."
        magick "$wallSqr" \
            \( -size 500x500 xc:white \
            -fill "rgba(0,0,0,0.7)" -draw "polygon 400,500 500,500 500,0 450,0" \
            -fill black -draw "polygon 500,500 500,0 450,500" \) \
            -alpha Off -compose CopyOpacity -composite "$wallQad" ||
            echo "Warning: Failed to create quad version."
    fi

    [ -n "$temp_frame" ] && rm -f "$temp_frame"
}

generate_caches "$IMAGE" "$WALLPAPER_CACHE_DIR" &
matugen image "$IMAGE" &
wallust run "$IMAGE" &

echo "Wallpaper processing completed!"
echo "Cached versions available at: $WALLPAPER_CACHE_DIR"

# Exit immediately, letting the background processes continue
echo "Wallpaper set. Additional processing continuing in background."
exit 0
