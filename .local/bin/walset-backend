#!/bin/bash
# Wallpaper Manager Script
# This script sets a wallpaper and creates various cached versions for different uses

# Check if required tools are installed
check_dependencies() {
    local missing_deps=()
    for cmd in swww magick notify-send file; do
        if ! command -v "$cmd" &>/dev/null; then
            missing_deps+=("$cmd")
        fi
    done

    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo "Error: Missing dependencies: ${missing_deps[*]}"
        echo "Please install the required tools and try again."
        exit 1
    fi
}

# Check if the user provided an argument
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <path-to-image>"
    exit 1
fi

# Run dependency check
check_dependencies

IMAGE="$1"

# Check if the file exists and is an image
if [ ! -f "$IMAGE" ]; then
    echo "Error: '$IMAGE' does not exist."
    exit 1
fi

# A more robust image check using file command
if ! file "$IMAGE" | grep -qE 'image|bitmap|PNG|JPEG|JPG|GIF|BMP|SVG'; then
    echo "Error: '$IMAGE' is not a valid image file."
    exit 1
fi

# Send notification to the user
notify-send "Wallpaper" "Changing wallpaper..."

# Set the wallpaper using swww
swww img "$IMAGE" --transition-type="center" --transition-step=45 --transition-fps="60" || {
    echo "Error: Failed to set wallpaper with swww."
    exit 1
}

# Define cache directory and files
WALLPAPER_CACHE_DIR="$HOME/.cache/averell/"
wallSet="${WALLPAPER_CACHE_DIR}/original.set"
wallCur="${WALLPAPER_CACHE_DIR}/wall.set"
wallSqr="${WALLPAPER_CACHE_DIR}/wall.sqre" # Square crop of the wallpaper
wallTmb="${WALLPAPER_CACHE_DIR}/wall.thmb" # Thumbnail version
wallBlr="${WALLPAPER_CACHE_DIR}/wall.blur" # Blurred version for backgrounds
wallQad="${WALLPAPER_CACHE_DIR}/wall.quad"
# wallDcl="${WALLPAPER_CACHE_DIR}/wall.dcol" # Dominant color extraction

# Ensure cache directory exists
mkdir -p "$WALLPAPER_CACHE_DIR"

# Save original image path
echo "$IMAGE" >"$wallSet"
ln -sf "$IMAGE" "$wallCur"

# Determine image format
extension="${IMAGE##*.}"
extension_lc="$(echo "$extension" | tr '[:upper:]' '[:lower:]')"

# If it's a gif, extract first frame for processing
if [ "$extension_lc" = "gif" ]; then
    TEMP_FRAME="${WALLPAPER_CACHE_DIR}/wall.firstframe.png"
    magick "$IMAGE[0]" "$TEMP_FRAME" || {
        echo "Warning: Failed to extract first frame from GIF."
    }
    CACHE_SRC="$TEMP_FRAME"
else
    CACHE_SRC="$IMAGE"
fi

# Generate cached versions using ImageMagick
echo "Generating square crop..."
magick "$CACHE_SRC" -strip -thumbnail 500x500^ -gravity center -extent 500x500 "$wallSqr" || echo "Warning: Failed to create square crop."

echo "Generating thumbnail..."
magick "$CACHE_SRC" -strip -thumbnail 320x180^ -gravity center -extent 320x180 "$wallTmb" || echo "Warning: Failed to create thumbnail."

echo "Generating blurred version..."
magick "$CACHE_SRC" -strip -resize 1920x1080^ -gravity center -extent 1920x1080 -blur 0x8 "$wallBlr" || echo "Warning: Failed to create blurred wallpaper."

echo "Generating quad version..."
magick "$wallSqr" \( -size 500x500 xc:white -fill "rgba(0,0,0,0.7)" -draw "polygon 400,500 500,500 500,0 450,0" -fill black -draw "polygon 500,500 500,0 450,500" \) \
    -alpha Off -compose CopyOpacity -composite "${wallQad}.png" &&
    mv "${wallQad}.png" "$wallQad" || echo "Warning: Failed to create quad version."

# echo "Extracting dominant color..."
# magick "$CACHE_SRC" -resize 1x1 txt:- | grep -oP '#\w+' | head -n1 >"$wallDcl" || echo "Warning: Failed to extract dominant color."

# Clean up temp frame if needed
[ -f "$TEMP_FRAME" ] && rm "$TEMP_FRAME"

echo "Wallpaper set successfully!"
echo "Cached versions available at: $WALLPAPER_CACHE_DIR"

# Optional: List all generated files
echo "Generated files:"
ls -l "$WALLPAPER_CACHE_DIR"
