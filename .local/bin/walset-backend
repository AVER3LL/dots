#!/bin/bash
set -euo pipefail

# ─── Directories ─────────────────────────────────────────────
WALL_DIR="$HOME/wallpaper/"
CACHE_DIR="$HOME/.cache/averell"
MATUGEN_SCRIPTS_DIR="$HOME/.config/matugen/scripts"

WALL_CURRENT="$CACHE_DIR/wall.set"
WALL_STATIC="$CACHE_DIR/wall.static"
WALL_SQUARE="$CACHE_DIR/wall.sqre"
WALL_QUAD="$CACHE_DIR/wall.quad"
WALL_THUMB="$CACHE_DIR/wall.thmb"
WALL_BLUR="$CACHE_DIR/wall.blur"
WALL_RECT="$CACHE_DIR/wall.rect"

[[ "$WALL_DIR" != */ ]] && WALL_DIR="${WALL_DIR}/"

# ─── Parse arguments ─────────────────────────────────────────
MODE_OVERRIDE=""
IMG=""

while [[ $# -gt 0 ]]; do
    case "$1" in
    --mode)
        if [[ -n "${2-}" ]]; then
            MODE_OVERRIDE="$2"
            shift 2
        else
            echo "Error: --mode requires an argument (light or dark)" >&2
            exit 1
        fi
        ;;
    -h | --help)
        echo "Usage: $0 [--mode light|dark] <image>"
        exit 0
        ;;
    *)
        IMG="$1"
        shift
        ;;
    esac
done

if [[ -z "$IMG" ]]; then
    echo "Error: No image specified."
    echo "Usage: $0 [--mode light|dark] <image>"
    exit 1
fi

if [[ ! -f "$IMG" ]]; then
    echo "Error: File not found — $IMG"
    exit 1
fi

# ─── Determine theme mode ────────────────────────────────────
if [[ -n "$MODE_OVERRIDE" ]]; then
    theme="$MODE_OVERRIDE"
else
    theme=$("$HOME/.local/bin/toggle-mode" --current)
fi

# ─── Generate scheme and theme ───────────────────────────────
detected=$("$MATUGEN_SCRIPTS_DIR/pick_monet_scheme.py" "$IMG" 2>/dev/null | tr -d '\n')
detected="${detected:-scheme-tonal-spot}"

echo "Matugen mode: $theme"
echo "Detected scheme: $detected"

killall -9 waybar || true

matugen image --mode "$theme" --type "$detected" "$IMG"
# wallust run "$IMG"

~/.config/waybar/toggle.sh

# ─── Optional Vicinae integration ────────────────────────────
if command -v vicinae >/dev/null 2>&1; then
    vicinae vicinae://theme/set/matugen
else
    echo "vicinae command not found"
fi

# ─── ImageMagick processing ──────────────────────────────────
magick "$IMG" -strip -resize 1000 -gravity center -extent 1000 -blur "30x30" -quality 90 "$WALL_BLUR"
magick "$IMG" -strip -resize 1000 -gravity center -extent 1000 -quality 90 "$WALL_THUMB"
magick "$IMG" -strip -thumbnail 500x500^ -gravity center -extent 500x500 "$WALL_SQUARE"

magick "$WALL_SQUARE" \
    \( -size 500x500 xc:white -fill "rgba(0,0,0,0.7)" -draw "polygon 400,500 500,500 500,0 450,0" \
    -fill black -draw "polygon 500,500 500,0 450,500" \) \
    -alpha Off -compose CopyOpacity -composite "$CACHE_DIR/currentWalQuad.png"

mv "$CACHE_DIR/currentWalQuad.png" "$WALL_QUAD"

ln -sf "$IMG" "$WALL_CURRENT"

# ─── Restart polkit agent ────────────────────────────────────
pkill -f "/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1" >/dev/null 2>&1 || true
/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 >/dev/null 2>&1 &

# ─── Update Fish theme (if available) ────────────────────────
if command -v fish &>/dev/null; then
    fish -c "yes | fish_config theme save Matugen" 2>/dev/null &
fi

# ─── Notify completion ───────────────────────────────────────
notify-send \
    -h string:x-canonical-private-synchronous:matugen_notif \
    "MatugenMagick" "Matugen & ImageMagick have completed their job" \
    -i "$HOME/Pictures/face.png"
