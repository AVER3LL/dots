#!/bin/bash
# Wallpaper Manager Script
# This script sets a wallpaper and creates various cached versions for different uses

# Check if required tools are installed
check_dependencies() {
    local missing_deps=()
    for cmd in swww matugen magick notify-send file; do
        if ! command -v "$cmd" &>/dev/null; then
            missing_deps+=("$cmd")
        fi
    done

    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo "Error: Missing dependencies: ${missing_deps[*]}"
        notify-send "Wallpaper error" "Error: Missing dependencies: ${missing_deps[*]}"
        echo "Please install the required tools and try again."
        exit 1
    fi
}

# Check if the user provided an argument
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <path-to-image>"
    exit 1
fi

# Run dependency check
check_dependencies

IMAGE="$1"

# Check if the file exists and is an image
if [ ! -f "$IMAGE" ]; then
    echo "Error: '$IMAGE' does not exist."
    exit 1
fi

# A more robust image check using file command
if ! file "$IMAGE" | grep -qE 'image|bitmap|PNG|JPEG|JPG|GIF|BMP|SVG'; then
    echo "Error: '$IMAGE' is not a valid image file."
    exit 1
fi

# Send notification to the user
notify-send "Wallpaper" "Changing wallpaper..."

# Set the wallpaper using swww - this happens first and doesn't wait
swww img "$IMAGE" --transition-type="center" || {
    echo "Error: Failed to set wallpaper with swww."
    exit 1
}

# Define cache directory and files
WALLPAPER_CACHE_DIR="$HOME/.cache/averell/"
wallSet="${WALLPAPER_CACHE_DIR}/original.set"
wallCur="${WALLPAPER_CACHE_DIR}/wall.set"
wallSqr="${WALLPAPER_CACHE_DIR}/wall.sqre" # Square crop of the wallpaper
wallTmb="${WALLPAPER_CACHE_DIR}/wall.thmb" # Thumbnail version
wallBlr="${WALLPAPER_CACHE_DIR}/wall.blur" # Blurred version for backgrounds
wallQad="${WALLPAPER_CACHE_DIR}/wall.quad"

# Ensure cache directory exists
mkdir -p "$WALLPAPER_CACHE_DIR"

# Save original image path
echo "$IMAGE" >"$wallSet"
ln -sf "$IMAGE" "$wallCur"

# Create a function for the background processing
generate_caches() {
    local image="$1"
    local cache_dir="$2"

    # Determine image format
    local extension="${image##*.}"
    local extension_lc="$(echo "$extension" | tr '[:upper:]' '[:lower:]')"
    local cache_src="$image"
    local temp_frame=""

    # If it's a gif, extract first frame for processing
    if [ "$extension_lc" = "gif" ]; then
        temp_frame="${cache_dir}/wall.firstframe.png"
        magick "$image[0]" "$temp_frame" || {
            echo "Warning: Failed to extract first frame from GIF."
        }
        cache_src="$temp_frame"
    fi

    # Generate cached versions using ImageMagick
    echo "Generating square crop..."
    magick "$cache_src" -strip -thumbnail 500x500^ -gravity center -extent 500x500 "$wallSqr" || echo "Warning: Failed to create square crop."

    echo "Generating thumbnail..."
    magick "$cache_src" -strip -thumbnail 320x180^ -gravity center -extent 320x180 "$wallTmb" || echo "Warning: Failed to create thumbnail."

    echo "Generating blurred version..."
    magick "$cache_src" -strip -resize 1920x1080^ -gravity center -extent 1920x1080 -blur 0x8 "$wallBlr" || echo "Warning: Failed to create blurred wallpaper."

    echo "Generating quad version..."
    magick "$wallSqr" \( -size 500x500 xc:white -fill "rgba(0,0,0,0.7)" -draw "polygon 400,500 500,500 500,0 450,0" -fill black -draw "polygon 500,500 500,0 450,500" \) \
        -alpha Off -compose CopyOpacity -composite "${wallQad}.png" &&
        mv "${wallQad}.png" "$wallQad" || echo "Warning: Failed to create quad version."

    # Clean up temp frame if needed
    [ -n "$temp_frame" ] && [ -f "$temp_frame" ] && rm "$temp_frame"
}

# Run the most time-consuming tasks in the background
# Generate all the cached versions
generate_caches "$IMAGE" "$WALLPAPER_CACHE_DIR"

# Use Matugen to generate Material You colors (the slowest part)
matugen image "$IMAGE" -m "dark"

wallust run "$IMAGE"

# Refresh swaync
pkill swaync
swaync > /dev/null 2>&1 &

# Refresh waybar
# sleep 2
# $HOME/.config/waybar/scripts/launch.sh


echo "Wallpaper processing completed!"
echo "Cached versions available at: $WALLPAPER_CACHE_DIR"

# Exit immediately, letting the background processes continue
echo "Wallpaper set. Additional processing continuing in background."
exit 0
