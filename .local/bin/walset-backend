#!/usr/bin/env bash
# Wallpaper Manager Script
# This script sets a wallpaper and creates various cached versions for different uses

# Initialize default values
SET_WALLPAPER=true

config="$HOME/.config/gtk-3.0/settings.ini"
current_theme=$(grep 'gtk-application-prefer-dark-theme' "$config" | sed 's/.*=\s*//' | tr -d ' ')

WALLPAPER_ENGINE="hyprpaper"
MODE="dark"
if [[ "$current_theme" == "0" ]]; then
    MODE="light"
else
    MODE="dark"
fi

# Function to show usage
show_usage() {
    echo "Usage: $0 [--no-set] [--mode=<dark|light>] <path-to-image>"
    echo "Options:"
    echo "  --no-set         Skip setting the wallpaper"
    echo "  --mode=<mode>    Set color scheme mode (dark or light, default: dark)"
    echo "Examples:"
    echo "  $0 /path/to/image.jpg"
    echo "  $0 --mode=light /path/to/image.jpg"
    echo "  $0 --no-set --mode=dark /path/to/image.jpg"
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
    --no-set)
        SET_WALLPAPER=false
        shift
        ;;
    --mode=*)
        MODE="${1#*=}"
        if [[ "$MODE" != "dark" && "$MODE" != "light" ]]; then
            echo "Error: Invalid mode '$MODE'. Must be 'dark' or 'light'."
            exit 1
        fi
        shift
        ;;
    --help | -h)
        show_usage
        exit 0
        ;;
    -*)
        echo "Error: Unknown option $1"
        show_usage
        exit 1
        ;;
    *)
        # This should be the image path
        IMAGE="$1"
        shift
        ;;
    esac
done

# Check if required tools are installed
check_dependencies() {
    # local critical_deps=(swww matugen wallust)
    local critical_deps=(hyprpaper matugen wallust)
    local missing_deps=()
    for cmd in "${critical_deps[@]}"; do
        command -v "$cmd" >/dev/null 2>&1 || missing_deps+=("$cmd")
    done

    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo "Error: Missing critical dependencies: ${missing_deps[*]}" >&2
        notify-send "Wallpaper error" "Error: Missing dependencies: ${missing_deps[*]}"
        echo "Please install the required tools and try again."
        exit 1
    fi
}

# Check if the user provided an image path
if [ -z "$IMAGE" ]; then
    echo "Error: No image path provided."
    show_usage
    exit 1
fi

# Run dependency check
check_dependencies

# Check if the file exists and is an image
if [ ! -f "$IMAGE" ]; then
    echo "Error: '$IMAGE' does not exist."
    exit 1
fi

# A more robust image check using file command
if ! file "$IMAGE" | grep -qE 'image|bitmap|PNG|JPEG|JPG|GIF|BMP|SVG'; then
    echo "Error: '$IMAGE' is not a valid image file."
    exit 1
fi

# Send notification to the user
echo "Changing wallpaper with mode: $MODE"

# Set the wallpaper using swww - this happens first and doesn't wait
if $SET_WALLPAPER; then
    if [ "$WALLPAPER_ENGINE" = "swww" ]; then
        swww img "$IMAGE" --transition-type="left" --transition-duration=2 --transition-step=255 --transition-angle=0 --transition-fps=60 || {
            echo "Error: Failed to set wallpaper with swww."
            exit 1
        }
    else
        hyprctl hyprpaper reload ,"$IMAGE" || {
            echo "Error: Failed to set wallpaper with hyprpaper."
            exit 1
        }
    fi
fi

brightness=$(magick "$IMAGE" -colorspace Gray -resize 1x1\! -format "%[fx:round(255*r)]" info:)
if [ -z "$brightness" ] || ! [[ "$brightness" =~ ^[0-9]+$ ]]; then
    echo "Warning: Could not calculate brightness, defaulting to dark theme"
    brightness=100 # Default to below threshold (dark)
fi
threshold=130

if ((brightness > threshold)); then
    # Light background - use primary color for border
    sed -i 's/^\$hyprborder = .*/\$hyprborder = rgba({{colors.primary.default.hex_stripped}}ff)/' ~/.config/matugen/templates/hyprland-colors.conf
    sed -i 's/@define-color fg #f6f7fc;/@define-color fg #000000;/' ~/.config/waybar/themes/both/colors.css

    sed -i 's/@define-color tray_background rgba(21, 18, 27, 0);/@define-color tray_background rgba(21, 18, 27, 0.7);/' ~/.config/waybar/themes/both/colors.css

else
    # Dark background - use fixed dark color for border
    sed -i 's/^\$hyprborder = .*/\$hyprborder = rgba(3e4142ff)/' ~/.config/matugen/templates/hyprland-colors.conf
    sed -i 's/@define-color fg #000000;/@define-color fg #f6f7fc;/' ~/.config/waybar/themes/both/colors.css

    sed -i 's/@define-color tray_background rgba(21, 18, 27, 0.7);/@define-color tray_background rgba(21, 18, 27, 0);/' ~/.config/waybar/themes/both/colors.css
fi

# Define cache directory and files
WALLPAPER_CACHE_DIR="$HOME/.cache/averell/"
wallSet="${WALLPAPER_CACHE_DIR}/original.set"
wallCur="${WALLPAPER_CACHE_DIR}/wall.set"
wallSqr="${WALLPAPER_CACHE_DIR}/wall.sqre" # Square crop of the wallpaper
wallTmb="${WALLPAPER_CACHE_DIR}/wall.thmb" # Thumbnail version
wallBlr="${WALLPAPER_CACHE_DIR}/wall.blur" # Blurred version for backgrounds
wallQad="${WALLPAPER_CACHE_DIR}/wall.quad"

# Ensure cache directory exists
mkdir -p "$WALLPAPER_CACHE_DIR"

# Save original image path
ln -sf "$IMAGE" "$wallCur" &       # Background link creation
printf '%s\n' "$IMAGE" >"$wallSet" # More efficient than echo

# Create a function for the background processing
generate_caches() {
    local image="$1"
    local cache_dir="$2"

    local extension="${image##*.}"
    local extension_lc="$(echo "$extension" | tr '[:upper:]' '[:lower:]')"
    local cache_src="$image"
    local temp_frame=""

    mkdir -p "$cache_dir"

    # If it's a gif, extract first frame
    if [ "$extension_lc" = "gif" ]; then
        temp_frame="${cache_dir}/wall.firstframe.png"
        magick "$image[0]" "$temp_frame" || {
            echo "Warning: Failed to extract first frame from GIF."
        }
        cache_src="$temp_frame"
    fi

    echo "Processing all outputs in one pass..."

    magick "$cache_src" \
        -strip \
        \( +clone -thumbnail 500x500^ -gravity center -extent 500x500 -write "$wallSqr" +delete \) \
        \( +clone -thumbnail 320x180^ -gravity center -extent 320x180 -write "$wallTmb" +delete \) \
        \( +clone -resize 1920x1080^ -gravity center -extent 1920x1080 -blur 0x8 -write "$wallBlr" +delete \) \
        null: >/dev/null || echo "Warning: Failed to generate images."

    # Generate quad from square version
    if [ -f "$wallSqr" ]; then
        echo "Generating quad version..."
        magick "$wallSqr" \
            \( -size 500x500 xc:white \
            -fill "rgba(0,0,0,0.7)" -draw "polygon 400,500 500,500 500,0 450,0" \
            -fill black -draw "polygon 500,500 500,0 450,500" \) \
            -alpha Off -compose CopyOpacity -composite "$wallQad" ||
            echo "Warning: Failed to create quad version."
    fi

    [ -n "$temp_frame" ] && rm -f "$temp_frame"
}

generate_caches "$IMAGE" "$WALLPAPER_CACHE_DIR" &
matugen image "$IMAGE" --type=scheme-fidelity --mode="$MODE" &
wallust run "$IMAGE" --palette "$MODE" &

echo "Wallpaper processing completed!"
echo "Cached versions available at: $WALLPAPER_CACHE_DIR"

# Exit immediately, letting the background processes continue
echo "Wallpaper set. Additional processing continuing in background."
exit 0
