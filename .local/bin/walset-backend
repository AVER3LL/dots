#!/usr/bin/env bash
# Fast Wallpaper Manager - Streamlined for speed
set -euo pipefail

# Configuration
CACHE_DIR="$HOME/.cache/averell"
WALLPAPER_ENGINE="hyprpaper"
SET_WALLPAPER=true

# Get current theme mode from GTK settings
config="$HOME/.config/gtk-3.0/settings.ini"
current_theme=$(grep 'gtk-application-prefer-dark-theme' "$config" 2>/dev/null | sed 's/.*=\s*//' | tr -d ' ' || echo "1")
MODE="dark"
[[ "$current_theme" == "0" ]] && MODE="light"

# Parse arguments quickly
while [[ $# -gt 0 ]]; do
    case $1 in
    --no-set)
        SET_WALLPAPER=false
        shift
        ;;
    --gif)
        WALLPAPER_ENGINE="swww"
        shift
        ;;
    --mode=*)
        MODE="${1#*=}"
        shift
        ;;
    -*)
        echo "Unknown option: $1" >&2
        exit 1
        ;;
    *)
        IMAGE="$1"
        shift
        ;;
    esac
done

# Quick validation
[[ -z "${IMAGE:-}" ]] && {
    echo "Usage: $0 [--no-set] [--gif] <image>" >&2
    exit 1
}
[[ -f "$IMAGE" ]] || {
    echo "File not found: $IMAGE" >&2
    exit 1
}

# Create cache directory
mkdir -p "$CACHE_DIR"

# Cache file paths
wallCur="$CACHE_DIR/wall.set"
wallStatic="$CACHE_DIR/wall.static"
wallSqr="$CACHE_DIR/wall.sqre"
wallTmb="$CACHE_DIR/wall.thmb"
wallBlr="$CACHE_DIR/wall.blur"

# Link current wallpaper
ln -sf "$IMAGE" "$wallCur"

# Handle GIF vs static images
if [[ "$WALLPAPER_ENGINE" == "swww" ]]; then
    # For GIFs, create static version for brightness calculation
    if command -v magick >/dev/null; then
        magick "$IMAGE[0]" -strip -quality 85 "$wallStatic" 2>/dev/null || ln -sf "$IMAGE" "$wallStatic"
    else
        ln -sf "$IMAGE" "$wallStatic"
    fi
else
    ln -sf "$IMAGE" "$wallStatic"
fi

# Fast brightness calculation (single pixel sample)
calculate_brightness() {
    if command -v magick >/dev/null; then
        magick "$wallStatic" -resize 1x1! -format "%[fx:int(255*r*0.299+255*g*0.587+255*b*0.114)]" info: 2>/dev/null || echo 128
    else
        echo 128 # Default middle brightness
    fi
}

# Set wallpaper function
set_wallpaper() {
    if [[ "$WALLPAPER_ENGINE" == "swww" ]]; then
        # Kill hyprpaper if running
        pkill -x hyprpaper 2>/dev/null || true

        # Start swww-daemon if not running
        if ! pgrep -x swww-daemon >/dev/null; then
            swww-daemon --format xrgb &
            sleep 0.5 # Brief wait for daemon
        fi

        swww img "$IMAGE" --transition-type fade --transition-duration 0.5 2>/dev/null
    else
        # Kill swww if running
        swww kill 2>/dev/null || true

        # Start hyprpaper if not running
        if ! pgrep -x hyprpaper >/dev/null; then
            hyprpaper &
            sleep 0.3
        fi

        hyprctl hyprpaper reload ,"$wallStatic" 2>/dev/null
    fi
}

# Generate cache files and run matugen in parallel
generate_caches_and_theme() {
    if ! command -v magick >/dev/null; then
        echo "Warning: ImageMagick not found, skipping cache generation" >&2
        return 0
    fi

    # Use the static version for cache generation
    local src="$wallStatic"

    # Generate all caches in one ImageMagick call for maximum efficiency
    magick "$src" -strip -quality 80 \
        \( +clone -thumbnail 500x500^ -gravity center -extent 500x500 +write "$wallSqr" +delete \) \
        \( +clone -thumbnail 320x180^ -gravity center -extent 320x180 +write "$wallTmb" +delete \) \
        \( +clone -resize 1920x1080^ -gravity center -extent 1920x1080 -blur 0x8 +write "$wallBlr" +delete \) \
        null: 2>/dev/null &

    # Run matugen in parallel
    if command -v matugen >/dev/null; then
        matugen image "$wallStatic" --type=scheme-fidelity --mode="$MODE" >/dev/null 2>&1 &
    fi
}

# Main execution
echo "Setting wallpaper: $(basename "$IMAGE") (Mode: $MODE)"

# Calculate brightness
brightness=$(calculate_brightness)
echo "Brightness: $brightness"

# Set wallpaper if requested
if $SET_WALLPAPER; then
    set_wallpaper
    echo "Wallpaper set with $WALLPAPER_ENGINE"
fi

# Generate caches and apply theme in background
generate_caches_and_theme

echo "Done! Cache generation and theme application running in background."
