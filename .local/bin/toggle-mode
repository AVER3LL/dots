#!/usr/bin/env bash
# Script to toggle between dark and light mode system wide
set -euo pipefail

config="$HOME/.config/gtk-3.0/settings.ini"
gnome_schema="org.gnome.desktop.interface"
[[ ! -f "$config" ]] && { echo "Error: GTK config not found" >&2; exit 1; }

theme=$(awk -F= '/gtk-application-prefer-dark-theme/{print $2}' "$config" | tr -d ' ')

if [[ "$theme" == "0" ]]; then
    prefer_dark="1"; prefer="prefer-dark"; mode="dark"; icon="Papirus-Dark"
else
    prefer_dark="0"; prefer="prefer-light"; mode="light"; icon="Papirus-Light"
fi

gsettings set "$gnome_schema" gtk-theme "adw-gtk3" &
gsettings set "$gnome_schema" color-scheme "$prefer" &
gsettings set "$gnome_schema" icon-theme "$icon" &
wait

wall=$(readlink ~/.cache/averell/wall.set 2>/dev/null || :)
[[ -x ~/.local/bin/walset-backend && -n "$wall" ]] && ~/.local/bin/walset-backend --mode="$mode" "$wall"

sed -i \
    -e "s/^gtk-application-prefer-dark-theme\s*=.*/gtk-application-prefer-dark-theme=$prefer_dark/" \
    -e "s/^gtk-icon-theme-name\s*=.*/gtk-icon-theme-name=$icon/" \
    "$config"

echo "Theme switched to $mode mode"
