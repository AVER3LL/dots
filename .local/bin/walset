#!/bin/bash
# Simple Wallpaper Selector Script with Thumbnail Support
# Uses C program to build Rofi input for speed

WALL_DIR="$HOME/wallpaper/"
BACKEND_CMD="$HOME/Projects/rust/walset-backend/target/release/wallpaper-theme-manager"
THUMB_DIR="$HOME/.cache/wallpaper-thumbs"
BUILD_ROFI_INPUT_CMD="$HOME/.config/averell/bin/build-rofi-input"

[[ "$WALL_DIR" != */ ]] && WALL_DIR="${WALL_DIR}/"

[ ! -d "$WALL_DIR" ] && {
    notify-send "Wallpaper Selector" "Error: Wallpaper directory not found"
    echo "Error: Wallpaper directory not found"
    exit 1
}
command -v rofi &>/dev/null || {
    echo "Error: rofi not installed"
    exit 1
}
[ ! -x "$BACKEND_CMD" ] && {
    notify-send "Wallpaper Selector" "Backend not found"
    exit 1
}
[ ! -x "$BUILD_ROFI_INPUT_CMD" ] && {
    notify-send "Wallpaper Selector" "Rofi input builder not executable"
    exit 1
}

SELECTED_WALL=$("$BUILD_ROFI_INPUT_CMD" | rofi -dmenu -theme ~/.config/rofi/wallpaper.rasi -p "" -i)

theme=$("$HOME/.local/bin/toggle-mode" --current)

if [ -n "$SELECTED_WALL" ]; then
    echo "Setting wallpaper: $SELECTED_WALL"
    if matugen image --type 'scheme-fidelity' --mode "$theme" "$WALL_DIR$SELECTED_WALL"; then
        echo "Wallpaper set successfully!"
    else
        echo "Failed to set wallpaper"
        exit 1
    fi
else
    echo "Wallpaper selection cancelled"
    exit 1
fi
