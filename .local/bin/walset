#!/bin/bash
# Wallpaper Selector Script
# This script provides a rofi interface to select wallpapers from a directory

# Configuration
WALL_DIR="$HOME/wallpaper/"
BACKEND_CMD="$HOME/.local/bin/walset-backend"

# Ensure wallpaper directory path ends with a slash
[[ "$WALL_DIR" != */ ]] && WALL_DIR="${WALL_DIR}/"

# Check if wallpaper directory exists
if [ ! -d "$WALL_DIR" ]; then
    notify-send "Wallpaper Selector" "Error: Wallpaper directory not found: $WALL_DIR"
    echo "Error: Wallpaper directory not found: $WALL_DIR"
    exit 1
fi

# Check if rofi is installed
if ! command -v rofi &>/dev/null; then
    echo "Error: rofi is not installed. Please install it and try again."
    exit 1
fi

# Check if backend command is available
if [ ! -x "$BACKEND_CMD" ]; then
    notify-send "Wallpaper Selector" "Error: Backend command not found: $BACKEND_CMD"
    echo "Error: Backend command not found: $BACKEND_CMD"
    exit 1
fi

# Handle spaces in filenames
IFS=$'\n'

# Find all supported image files in one go
# Use find command with absolute paths
image_files=($(find "$WALL_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.webp" -o -iname "*.bmp" \) -printf "%P\n"))

# Check if any wallpapers were found
if [ ${#image_files[@]} -eq 0 ]; then
    notify-send "Wallpaper Selector" "No wallpapers found in $WALL_DIR"
    echo "No wallpapers found in $WALL_DIR"
    exit 1
fi

# Build the rofi menu with image icons
rofi_input=""
for file in "${image_files[@]}"; do
    rofi_input+="$file\0icon\x1f$WALL_DIR$file\n"
done

# Show rofi selection dialog
SELECTED_WALL=$(echo -en "$rofi_input" | rofi -dmenu -theme ~/.config/rofi/wallpaper.rasi -p "" -i)

# Process the selection
if [ -n "$SELECTED_WALL" ]; then
    echo "Setting wallpaper: $SELECTED_WALL"

    # Use the absolute path directly
    "$BACKEND_CMD" "$WALL_DIR$SELECTED_WALL"
    exit_status=$?

    if [ $exit_status -eq 0 ]; then
        echo "Wallpaper set successfully!"
    else
        echo "Failed to set wallpaper. Backend command exited with status $exit_status"
    fi
else
    echo "Wallpaper selection cancelled"
fi
